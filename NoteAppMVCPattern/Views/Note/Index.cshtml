@model NoteApp.WebUI.Models.ViewModel.NoteIndexVM
@using System.Linq
@using NoteApp.WebUI.Models.ViewModel;

@{
    Layout = "_noteIndexLayout";
    ViewData["Title"] = "Notlar";
    // Bu dictionary, her Tag adına bir renk atamak için kullanılır.
    
}
@await Html.PartialAsync("_TempDataMessage")

<div class="container py-4">
    @if (Model.Notes == null || Model.Notes.Count == 0)
    {
        <div class="text-center mt-5">
            <i class="bi bi-journal-x display-1 text-muted mb-3"></i>
            <p class="lead">Hiç notun yok.</p>
            <a asp-action="Create" class="btn btn-lg btn-primary">
                <input type="hidden" name="notebookId" value="@Model.NotebookID" />
                <i class="bi bi-journal-plus"></i> İlk Notunu Ekle
            </a>
        </div>
    }
    else
    {
          var notebookTags = Model.Notebooks.FirstOrDefault(x => x.Id == Model.NotebookID);


		var tags = notebookTags?.Notes.SelectMany(x => x.Tags)
            .Distinct()
            .OrderByDescending(x => x.TagUsageCount)
            .Take(5)
            .ToList();

            Console.WriteLine();
        @* 
            Butonların başladığı yer 
        *@

        <div class="d-flex justify-content-end m-2 gap-2 mb-3">
          @*  @if(Model.NotebookID != null)
            {
                <a class="btn btn-danger" asp-action="Index" asp-controller="Notebook">Not defteri seç</a>
            } *@

            @if (Model.SelectedTagIds != null && Model.SelectedTagIds.Any())
            {
                @if (Model.CurrentTag != null)
                {
                    var tagcolor = Model.CurrentTag.TagColor.Substring(3);
                    var tagName = Model.CurrentTag.TagName;

                    <a class="btn btn-@tagcolor" asp-action="Index" asp-route-notebookId="@Model.NotebookID">Aktif tag : @tagName</a>
                }
                <a class="btn btn-danger" asp-action="Index" asp-route-notebookId="@Model.NotebookID">Filtreyi Kaldır</a>
            }

            <a asp-action="Create" class="btn btn-primary">
                <input type="hidden" name="notebookId" value="@Model.NotebookID" />
                <i class="bi bi-journal-plus"></i> Yeni Not
            </a>
            
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle me-3" data-bs-toggle="dropdown">
                    Sırala
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" asp-action="Index" asp-route-notebookId="@Model.NotebookID" asp-route-sortOrder="date_desc">Yeniden → Eskiye</a></li>
                    <li><a class="dropdown-item" asp-action="Index" asp-route-notebookId="@Model.NotebookID" asp-route-sortOrder="date_asc">Eskiden → Yeniye</a></li>
                    @{Console.WriteLine();}
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header">Tag'e Göre Filtrele</li>

                    @* Burada Model.AvailableTags (List<Tag>) kullanıldığını varsayıyoruz *@
                    @{
                        
                        
                        @foreach (var tag in tags)
                        {          
                            <li><a class="dropdown-item" asp-action="Index" asp-route-notebookId="@Model.NotebookID"  asp-route-tagIds="@tag.Id">@tag.TagName</a></li>
                        }
                    }

                </ul>
            </div>
        </div>

        <div class="container mt-3 position-relative">
            @if (Model.ViewMode == "grid")
            {
                <div class="row g-3">
                    @foreach (var note in Model.Notes)
                    {
                        <partial name="_NoteCard" model="new NoteFooterVM 
                                {Note = note, Tags = tags }" />
                    }

                </div>                        
            }
           
            @* List View (Sadeleştirilmiş) *@
            @* else (Model.ViewMode == "list")
            {
                <ul class="list-group">
                    @for (int i = 0; i < Model.Notes.Count; i++)
                    {
                        var note = Model.Notes[i];
                        <li class="list-group-item d-flex align-items-start justify-content-between">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-muted fw-bold display-6">@(i + 1)</div>
                                <div>
                                    <h5 class="mb-1">@note.Title</h5>
                                    <p class="mb-0 text-muted small">@note.Content</p>
                                </div>
                            </div>

                            @if (note.Tags != null && note.Tags.Any())
                            {
                                <div class="d-flex align-self-center">
                                    @foreach (var tag in note.Tags)
                                    {
                                    @*
                                        if (!tagColorPairs.ContainsKey(tag.TagName))
                                        {
                                            tagColorPairs[tag.TagName] = colors[colorIndex % colors.Count];
                                            colorIndex++;
                                        }
                                        var color = tagColorPairs[tag.TagName]; 
                                       <div> 
                                           <button type="button"
                                            class="badge 
                                                 @tag.TagColor text-dark align-self-center me-2" 
                                                 style="cursor:pointer;"
                                                 onclick="selectTag('@tag.Id')">
                                                #@tag.TagName

                                            </button>
                                        
                                    </div>
                                    }
                                </div>
                            }
                        </li>
                    }
                </ul>
            } *@
        </div>
    }
</div>
<div id="modal-container"></div>

@section Scripts {
    <script>
        $(document).on("click", ".view-note", function () {
            const id = $(this).data("id");
            $.get(`/Note/NoteDetails?noteId=${id}`, function (data) {
                $("#modal-container").html(data);
                const modal = new bootstrap.Modal(document.getElementById('myModal'));
                modal.show();
            });
        });

        // Bagde onClick func.

            function selectTag(tagId) 
            {
            // örnek: filtreleme veya AJAX çağrısı
            console.log("Seçilen tag ID:", tagId);
            window.location.href = `/Note/Index?tagIds=${tagId}`;
            }
                     $(document).on("click", ".tag-color-partial", function () {
            const id = $(this).data("id");            
            $.get(`/Note/TagColorPage?tagId=${id}`, function (data) {
                $("#modal-container").html(data);
                const modal = new bootstrap.Modal(document.getElementById('tagColorUpdate'));
                modal.show();
            });              
                     });
        //                              $(document).ready(function () {
        //   $(".tag-search-input").on("keyup", function () {
        //     const noteId = $(this).data("note-id");
        //     const value = $(this).val().toLowerCase();
        //     $(`#tagdropdown-delete-${noteId} .tag-item`).each(function () {
        //       const text = $(this).text().toLowerCase();
        //       $(this).toggle(text.includes(value));
        //     });
        //   });
        // });

                $(document).ready(function () {
          $(".tag-search-input").on("keyup", function () {
            const noteId = $(this).data("note-id");
            const value = $(this).val().toLowerCase();
            const mode = $(this).data("mode");
            const items = $(`#tagdropdown-${noteId} .tag-${mode}-item`);

            if (value === "") {
              // Arama kutusu boşsa, sadece ilk 3 tag’i göster
              items.each(function (index) {
                $(this).css("display", index < 3 ? "block" : "none");
              });
            } else {
              // Arama varsa, eşleşenleri göster
              items.each(function () {
                const text = $(this).text().toLowerCase();
                $(this).css("display", text.includes(value) ? "block" : "none");
              });
            }
          });
        });

                        function edit(el) {
            const text = el.innerText;

            // Input oluştur
            const input = document.createElement('input');
            input.id = 'editTitle';
            input.value = text;
            input.dataset.id = el.dataset.id;
            input.classList.add('form-control'); // istersen bootstrap

            // Eventler
            input.onblur = () => save(input);
            input.onkeydown = function(e) { if(e.key === 'Enter') save(input); };

            // h5’i input ile değiştir
            el.replaceWith(input);
            input.focus();
        }

        function save(input) {
            const newValue = input.value;
            const id = input.dataset.id;

            fetch('/Note/UpdateTitle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, title: newValue })
            })
            .then(res => res.json())
            .then(data => {
                // Başarılıysa input'u tekrar h5'e çevir
                const h5 = document.createElement('h5');
                h5.className = 'card-header text-center';
                h5.style.cursor = 'pointer';
                h5.dataset.id = id;
                h5.innerText = newValue;
                h5.onclick = function() { edit(h5); };

                input.replaceWith(h5);
            })
            .catch(err => {
                console.error(err);
                // Hata olursa eski değeri geri koy
                const h5 = document.createElement('h5');
                h5.className = 'card-header text-center';
                h5.style.cursor = 'pointer';
                h5.dataset.id = id;
                h5.innerText = input.value; // veya eski değeri saklayıp koyabilirsin
                h5.onclick = function() { edit(h5); };

                input.replaceWith(h5);
            });
        }


    </script>
}