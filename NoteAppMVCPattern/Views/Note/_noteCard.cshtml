@model Note

<div class="col-12 col-sm-6 col-md-4 mb-4">
    <div class="card h-100 text-white bg-dark border-4 position-relative">

            @* Takvim dropdown*@  
         <partial name="_NoteStatusDropdown" model="Model" />

         @*Tag alanı *@
        <partial name="_NoteTagsPartial" model="Model.Tags" />

        @* Kart içeriği *@
        <div class="card-body mt-4">
            @* Badges için üstten biraz boşluk bırakıldı *@
            <h5 class="card-title">@Model.Title</h5>
            <p class="card-text text-truncate">@Model.Content</p>
            <p class="card-subtitle text-white-50 text-end text-break">@Model.CreateDate.ToShortDateString()</p>
        </div>

        @* footer *@
        <div class="card-footer  justify-content-between align-items-center">
        <div class="btn-group btn-group-sm">
            <a asp-action="Update" asp-route-id="@Model.Id"
               class="btn me-1 btn-primary btn-sm rounded">
                <i class="bi bi-pencil-square me-1"></i> Düzenle
            </a>

            <form asp-action="Delete" asp-route-id="@Model.Id" method="post"
                  onsubmit="return confirm('@Model.Title isimli notu silmek istediğinizden emin misiniz?')">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger btn-sm rounded me-1">
                    <i class="bi bi-trash3"></i> Sil
                </button>
            </form>
            <button class="btn btn-success view-note rounded me-1" data-id="@Model.Id">
                <i class="bi bi-eye"></i> İncele
            </button>
        </div>


        @* Seçenekeler Kısmı*@

        <div class="dropdown">
            <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle"
                    data-bs-toggle="dropdown" style="min-width: 50px">
                <i class="bi bi-gear"> Seç.</i>
            </button>

            <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 180px; max-width: 200px;">

                @* 1. Notun Mevcut Taglerini Silme *@
                @if (Model.Tags != null && Model.Tags.Any())
                {
                    <li class="dropdown-header">Mevcut Tag'ler (Sil)</li>
                    @foreach (var tag in Model.Tags)
                    {
                        <li class="mb-1">
                            <form asp-controller="Note" asp-action="DeleteTag" method="post" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="noteId" value="@Model.Id" />
                                <input type="hidden" name="tagId" value="@tag.Id" /> @* Tag'in ID'sini kullanıyoruz *@                                                                                                             
                                                                        <button type="submit" class="btn btn-danger btn-sm w-100 text-truncate">
                                    <i class="bi bi-bookmark-x"></i> Sil (#@tag.TagName)
                                </button>
                            </form>
                        </li>
                    }
                    <li><hr class="dropdown-divider my-2"></li>
                }

                @* 2. Var Olan Taglerden Ekleme *@
                @if (Model.Tags != null)
                {
                    <li class="dropdown-header">Var Olan Tag’ler (Ekle)</li>
                    @foreach (var tag in Model.Tags)
                    {
                        if (Model.Tags == null || !Model.Tags.Any(t => t.Id == tag.Id))
                        {
                            <li>
                                <form asp-controller="Note" asp-action="AddTag" method="post" style="display:inline;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="noteId" value="@Model.Id" />
                                    <input type="hidden" name="tagId" value="@tag.Id" /> @* **KRİTİK: Tag ID'si** *@
                                    <button type="submit" class="dropdown-item text-truncate">@tag.TagName</button>
                                </form>
                            </li>
                        }
                    }
                }

                @* 3. Yeni Tag Oluşturup Ekleme *@
                <li class="mb-2">
                    <form asp-controller="Note" asp-action="CreateAndAddTag" method="post">
                        @* **AKSIYON ADI DEĞİŞTİ** *@
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="noteId" value="@Model.Id" />
                        <input type="text" name="tagName" class="form-control form-control-sm mb-2" placeholder="Yeni Tag Adı" required /> @* **KRİTİK: Tag Adı** *@
                        <button type="submit" class="btn btn-info btn-sm w-100">
                            <i class="bi bi-bookmark-plus"></i> Oluştur & Ekle
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
    </div>
    </div>
    
